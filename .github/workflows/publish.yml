name: Publish to npm

on:
  release:
    types: [created]
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Debug - Workflow trigger info
        run: |
          echo "=== Workflow Trigger Debug Info ==="
          echo "Event name: ${{ github.event_name }}"
          echo "Repository: ${{ github.repository }}"
          echo "Actor: ${{ github.actor }}"
          echo "Ref: ${{ github.ref }}"
          if [ "${{ github.event_name }}" = "release" ]; then
            echo "Release action: ${{ github.event.action }}"
            echo "Release tag: ${{ github.event.release.tag_name }}"
            echo "Release draft: ${{ github.event.release.draft }}"
            echo "Release prerelease: ${{ github.event.release.prerelease }}"
            if [ "${{ github.event.release.draft }}" = "true" ]; then
              echo "‚ö†Ô∏è Warning: This is a draft release. Workflow only triggers on published releases."
            fi
          fi
          echo "=================================="
      
      - name: Debug - Check secrets access
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          echo "=== Debugging Secrets Access ==="
          echo "Repository: ${{ github.repository }}"
          echo "Event: ${{ github.event_name }}"
          echo "Actor: ${{ github.actor }}"
          echo ""
          echo "Checking if NPM_TOKEN secret is accessible..."
          # Â∞ùËØïËÆøÈóÆ secretÔºà‰∏ç‰ºöÊòæÁ§∫ÂÄºÔºå‰ΩÜÂèØ‰ª•Ê£ÄÊü•ÊòØÂê¶Â≠òÂú®Ôºâ
          TOKEN="$NPM_TOKEN"
          if [ -z "$TOKEN" ]; then
            echo "‚ùå NPM_TOKEN is empty or not accessible"
            echo ""
            echo "Possible causes:"
            echo "1. Secret name mismatch (must be exactly 'NPM_TOKEN')"
            echo "2. Secret not in Repository secrets (check Environment secrets vs Repository secrets)"
            echo "3. Workflow permissions issue"
            echo "4. Secret was just added and workflow needs to be re-run"
            echo ""
            echo "Action required:"
            echo "1. Go to: https://github.com/knott11/tree-processor/settings/secrets/actions"
            echo "2. Verify 'NPM_TOKEN' exists in 'Repository secrets' (not Environment secrets)"
            echo "3. Check the name is exactly 'NPM_TOKEN' (no spaces, case-sensitive)"
            echo "4. If missing, create a Granular Access Token:"
            echo "   - Go to https://www.npmjs.com/settings/[your-username]/access-tokens"
            echo "   - Click 'Generate New Token' ‚Üí 'Granular Access Token'"
            echo "   - Set permissions: Packages (Read and write)"
            echo "   - Copy token and add to GitHub Secrets"
          else
            TOKEN_LEN=${#TOKEN}
            echo "‚úÖ NPM_TOKEN secret is accessible"
            echo "Token length: $TOKEN_LEN characters"
            if [[ "$TOKEN" =~ ^npm_ ]]; then
              echo "‚úÖ Token format correct (starts with 'npm_')"
            else
              echo "‚ö†Ô∏è Token doesn't start with 'npm_', please verify"
            fi
          fi
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
          always-auth: true
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      
      - name: Extract version from tag
        id: version
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
            # ÁßªÈô§ 'v' ÂâçÁºÄÔºàÂ¶ÇÊûúÊúâ?
            VERSION=${VERSION#v}
          else
            # ?package.json ËØªÂèñÁâàÊú¨?
            VERSION=$(node -p "require('./package.json').version")
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"
          echo "Event name: ${{ github.event_name }}"
          if [ "${{ github.event_name }}" = "release" ]; then
            echo "Release tag: ${{ github.event.release.tag_name }}"
          fi
      
      - name: Update package.json version
        if: github.event_name == 'release'
        run: |
          TARGET_VERSION="${{ steps.version.outputs.version }}"
          # ÂéªÈô§ÂèØËÉΩÁöÑÁ©∫Ê†ºÂíåÊç¢Ë°åÁ¨¶
          TARGET_VERSION=$(echo "$TARGET_VERSION" | tr -d '[:space:]')
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          CURRENT_VERSION=$(echo "$CURRENT_VERSION" | tr -d '[:space:]')
          
          echo "Current version in package.json: '$CURRENT_VERSION'"
          echo "Target version from release tag: '$TARGET_VERSION'"
          echo "Version comparison: [${CURRENT_VERSION}] vs [${TARGET_VERSION}]"
          
          if [ "$CURRENT_VERSION" = "$TARGET_VERSION" ]; then
            echo "‚úÖ Version already matches ($CURRENT_VERSION), skipping update"
          else
            echo "üìù Versions differ, updating package.json from $CURRENT_VERSION to $TARGET_VERSION"
            # Â∞ùËØï‰ΩøÁî® npm versionÔºåÂ¶ÇÊûúÂ§±Ë¥•ÔºàÊØîÂ¶ÇÁâàÊú¨Â∑≤ÂåπÈÖçÔºâÔºåÂàôÂøΩÁï•ÈîôËØØ
            npm version "$TARGET_VERSION" --no-git-tag-version 2>&1 | tee /tmp/npm-version-output.log || {
              NPM_ERROR=$(cat /tmp/npm-version-output.log)
              if echo "$NPM_ERROR" | grep -q "Version not changed"; then
                echo "‚ÑπÔ∏è Version already matches (npm detected), skipping update"
              else
                echo "‚ö†Ô∏è npm version failed with error: $NPM_ERROR"
                echo "üìù Attempting to update package.json manually..."
                node -e "const fs=require('fs');const pkg=require('./package.json');pkg.version='$TARGET_VERSION';fs.writeFileSync('package.json',JSON.stringify(pkg,null,2)+'\n');"
                echo "‚úÖ Manually updated package.json version to $TARGET_VERSION"
              fi
            }
          fi
          echo "Final version in package.json:"
          cat package.json | grep -A 2 '"version"'
      
      - name: Verify NPM_TOKEN
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          echo "=== Verifying NPM_TOKEN ==="
          TOKEN="$NPM_TOKEN"
          
          # Ë∞ÉËØï‰ø°ÊÅØÔºà‰∏çÊòæÁ§∫ÂÆåÊï¥ tokenÔºâ
          if [ -z "$TOKEN" ]; then
            echo "‚ùå Error: NPM_TOKEN secret is not set or empty!"
            echo ""
            echo "Troubleshooting steps:"
            echo "1. Go to: https://github.com/knott11/tree-processor/settings/secrets/actions"
            echo "2. Verify that 'NPM_TOKEN' exists in Repository secrets (not Environment secrets)"
            echo "3. Check that the name is exactly 'NPM_TOKEN' (case-sensitive, no spaces)"
            echo "4. If it doesn't exist, click 'New repository secret' and add it"
            echo ""
            echo "To create an npm Granular Access Token:"
            echo "1. Go to https://www.npmjs.com/settings/[your-username]/access-tokens"
            echo "2. Click 'Generate New Token' ‚Üí 'Granular Access Token'"
            echo "3. Token name: e.g., 'GitHub Actions Publish'"
            echo "4. Expiration: Choose expiration (90 days max for granular tokens)"
            echo "5. Select permissions:"
            echo "   - Packages: Read and write"
            echo "   - Scopes: Select your package scope (or 'All packages')"
            echo "6. Copy the token and add it to GitHub Secrets with name 'NPM_TOKEN'"
            echo ""
            echo "Note: Granular tokens may have different formats than classic tokens"
            exit 1
          else
            TOKEN_LENGTH=${#TOKEN}
            echo "‚úÖ NPM_TOKEN is configured (length: $TOKEN_LENGTH characters)"
            echo "‚úÖ Token exists and will be used for publishing"
            # Granular tokens may have different formats, so we don't check for 'npm_' prefix
          fi
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run tests
        run: npm test
      
      - name: Build
        run: npm run build
      
      - name: Verify build output
        run: |
          echo "Checking build output..."
          ls -la dist/
          if [ ! -f "dist/tree-processor.cjs.js" ] || [ ! -f "dist/tree-processor.esm.js" ] || [ ! -f "dist/index.d.ts" ]; then
            echo "?Error: Build output files are missing!"
            exit 1
          else
            echo "?Build output files exist"
          fi
      
      - name: Check if version already exists
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "Checking if version $VERSION already exists on npm..."
          # setup-node Â∫îËØ•Â∑≤ÁªèÈÖçÁΩÆÂ•Ω‰∫ÜËÆ§ËØÅ
          if npm view tree-processor@$VERSION version > /dev/null 2>&1; then
            echo "‚ùå Error: Version $VERSION already exists on npm!"
            echo "Please use a different version number."
            exit 1
          else
            echo "‚úÖ Version $VERSION is available"
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      
      - name: Verify package.json
        run: |
          echo "Verifying package.json..."
          node -e "
            const pkg = require('./package.json');
            console.log('Package name:', pkg.name);
            console.log('Package version:', pkg.version);
            console.log('Package files:', pkg.files);
            if (!pkg.name || !pkg.version) {
              console.error('?Error: package.json is missing name or version');
              process.exit(1);
            }
          "
      
      - name: Configure npm for automation
        run: |
          echo "Verifying npm configuration..."
          # setup-node Â∫îËØ•Â∑≤ÁªèÈÖçÁΩÆÂ•Ω‰∫ÜËÆ§ËØÅÔºåËøôÈáåÂè™ÂÅöÈ™åËØÅ
          npm config get registry
          if npm config get //registry.npmjs.org/:_authToken > /dev/null 2>&1; then
            echo "‚úÖ npm authentication is configured"
          else
            echo "‚ö†Ô∏è Warning: npm authentication may not be configured correctly"
            echo "Creating .npmrc as fallback..."
            echo "//registry.npmjs.org/:_authToken=${{ secrets.NPM_TOKEN }}" > ~/.npmrc
            echo "registry=https://registry.npmjs.org/" >> ~/.npmrc
          fi
          echo "‚úÖ npm ready for publishing"
      
      - name: Publish to npm with provenance
        run: |
          echo "Publishing to npm with provenance..."
          echo "Package: tree-processor"
          echo "Version: ${{ steps.version.outputs.version }}"
          echo ""
          echo "Current npm configuration:"
          npm config get registry
          npm config get //registry.npmjs.org/:_authToken | head -c 20 && echo "..."
          echo ""
          # ‰ΩøÁî® set -o pipefail Á°Æ‰øùÁÆ°ÈÅì‰∏≠ÁöÑÈîôËØØËÉΩË¢´ÊçïËé∑
          set -o pipefail
          # Granular Access Token Â∫îËØ•ÂèØ‰ª•ÁªïËøá 2FA
          npm publish --provenance --access public 2>&1 | tee /tmp/npm-publish-output.log
          PUBLISH_EXIT_CODE=${PIPESTATUS[0]}
          if [ $PUBLISH_EXIT_CODE -ne 0 ]; then
            PUBLISH_ERROR=$(cat /tmp/npm-publish-output.log)
            echo ""
            echo "‚ùå npm publish failed with exit code: $PUBLISH_EXIT_CODE"
            echo "Error output:"
            echo "$PUBLISH_ERROR"
            echo ""
            echo "Common issues:"
            echo "1. 2FA required - ensure you're using a Granular Access Token"
            echo "2. Version already exists - check npm registry"
            echo "3. Token expired or invalid - regenerate token"
            echo "4. Package name conflict - check package name"
            echo "5. Network issues - check npm registry connectivity"
            exit 1
          fi
          echo ""
          echo "‚úÖ Successfully published to npm!"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      
      - name: Verify publication
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "Verifying publication..."
          echo "Waiting for npm CDN to sync (this may take up to 30 seconds)..."
          # ÊúÄÂ§öÁ≠âÂæÖ 30 ÁßíÔºåÊØè 5 ÁßíÊ£ÄÊü•‰∏ÄÊ¨°
          MAX_ATTEMPTS=6
          ATTEMPT=0
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            sleep 5
            ATTEMPT=$((ATTEMPT + 1))
            if npm view tree-processor@$VERSION version > /dev/null 2>&1; then
              echo ""
              echo "‚úÖ Successfully verified: tree-processor@$VERSION is now on npm"
              echo ""
              echo "Package details:"
              npm view tree-processor@$VERSION
              exit 0
            else
              echo "Attempt $ATTEMPT/$MAX_ATTEMPTS: Version not yet available, waiting..."
            fi
          done
          echo ""
          echo "‚ö†Ô∏è Warning: Could not verify publication after $MAX_ATTEMPTS attempts."
          echo "This may be due to npm CDN caching. Please check manually:"
          echo "  npm view tree-processor@$VERSION"
          echo ""
          echo "If the version exists, the publication was successful."
          echo "If not, please check the publish step logs for errors."