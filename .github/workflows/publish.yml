name: Publish to npm

on:
  release:
    types: [created]
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
      
      - name: Extract version from tag
        id: version
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
            # ÁßªÈô§ 'v' ÂâçÁºÄÔºàÂ¶ÇÊûúÊúâ?
            VERSION=${VERSION#v}
          else
            # ?package.json ËØªÂèñÁâàÊú¨?
            VERSION=$(node -p "require('./package.json').version")
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"
          echo "Event name: ${{ github.event_name }}"
          if [ "${{ github.event_name }}" = "release" ]; then
            echo "Release tag: ${{ github.event.release.tag_name }}"
          fi
      
      - name: Update package.json version
        if: github.event_name == 'release'
        run: |
          TARGET_VERSION="${{ steps.version.outputs.version }}"
          # ÂéªÈô§ÂèØËÉΩÁöÑÁ©∫Ê†ºÂíåÊç¢Ë°åÁ¨¶
          TARGET_VERSION=$(echo "$TARGET_VERSION" | tr -d '[:space:]')
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          CURRENT_VERSION=$(echo "$CURRENT_VERSION" | tr -d '[:space:]')
          
          echo "Current version in package.json: '$CURRENT_VERSION'"
          echo "Target version from release tag: '$TARGET_VERSION'"
          echo "Version comparison: [${CURRENT_VERSION}] vs [${TARGET_VERSION}]"
          
          if [ "$CURRENT_VERSION" = "$TARGET_VERSION" ]; then
            echo "‚úÖ Version already matches ($CURRENT_VERSION), skipping update"
          else
            echo "üìù Versions differ, updating package.json from $CURRENT_VERSION to $TARGET_VERSION"
            # Â∞ùËØï‰ΩøÁî® npm versionÔºåÂ¶ÇÊûúÂ§±Ë¥•ÔºàÊØîÂ¶ÇÁâàÊú¨Â∑≤ÂåπÈÖçÔºâÔºåÂàôÂøΩÁï•ÈîôËØØ
            npm version "$TARGET_VERSION" --no-git-tag-version 2>&1 | tee /tmp/npm-version-output.log || {
              NPM_ERROR=$(cat /tmp/npm-version-output.log)
              if echo "$NPM_ERROR" | grep -q "Version not changed"; then
                echo "‚ÑπÔ∏è Version already matches (npm detected), skipping update"
              else
                echo "‚ö†Ô∏è npm version failed with error: $NPM_ERROR"
                echo "üìù Attempting to update package.json manually..."
                node -e "const fs=require('fs');const pkg=require('./package.json');pkg.version='$TARGET_VERSION';fs.writeFileSync('package.json',JSON.stringify(pkg,null,2)+'\n');"
                echo "‚úÖ Manually updated package.json version to $TARGET_VERSION"
              fi
            }
          fi
          echo "Final version in package.json:"
          cat package.json | grep -A 2 '"version"'
      
      - name: Verify NPM_TOKEN
        run: |
          echo "Checking NPM_TOKEN configuration..."
          TOKEN="${{ secrets.NPM_TOKEN }}"
          
          # Ë∞ÉËØï‰ø°ÊÅØÔºà‰∏çÊòæÁ§∫ÂÆåÊï¥ tokenÔºâ
          if [ -z "$TOKEN" ]; then
            echo "‚ùå Error: NPM_TOKEN secret is not set or empty!"
            echo ""
            echo "Troubleshooting steps:"
            echo "1. Go to: https://github.com/knott11/tree-processor/settings/secrets/actions"
            echo "2. Verify that 'NPM_TOKEN' exists in Repository secrets"
            echo "3. Check that the name is exactly 'NPM_TOKEN' (case-sensitive)"
            echo "4. If it doesn't exist, click 'New repository secret' and add it"
            echo ""
            echo "To create an npm token:"
            echo "1. Go to https://www.npmjs.com/settings/[your-username]/tokens"
            echo "2. Generate New Token (Classic)"
            echo "3. Select 'Automation' type with 'Read and write' permissions"
            echo "4. Copy the token (starts with 'npm_')"
            echo "5. Add it to GitHub Secrets with name 'NPM_TOKEN'"
            exit 1
          else
            TOKEN_LENGTH=${#TOKEN}
            echo "‚úÖ NPM_TOKEN is configured (length: $TOKEN_LENGTH characters)"
            
            # È™åËØÅ token Ê†ºÂºèÔºànpm tokens ÈÄöÂ∏∏‰ª• npm_ ÂºÄÂ§¥Ôºâ
            if [[ "$TOKEN" =~ ^npm_ ]]; then
              echo "‚úÖ Token format looks correct (starts with 'npm_')"
              echo "‚úÖ First 10 characters: ${TOKEN:0:10}..."
            else
              echo "‚ö†Ô∏è Warning: Token doesn't start with 'npm_', please verify it's a valid npm token"
              echo "‚ö†Ô∏è First 10 characters: ${TOKEN:0:10}..."
            fi
          fi
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run tests
        run: npm test
      
      - name: Build
        run: npm run build
      
      - name: Verify build output
        run: |
          echo "Checking build output..."
          ls -la dist/
          if [ ! -f "dist/tree-processor.cjs.js" ] || [ ! -f "dist/tree-processor.esm.js" ] || [ ! -f "dist/index.d.ts" ]; then
            echo "?Error: Build output files are missing!"
            exit 1
          else
            echo "?Build output files exist"
          fi
      
      - name: Check if version already exists
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "Checking if version $VERSION already exists on npm..."
          if npm view tree-processor@$VERSION version > /dev/null 2>&1; then
            echo "?Error: Version $VERSION already exists on npm!"
            echo "Please use a different version number."
            exit 1
          else
            echo "?Version $VERSION is available"
          fi
      
      - name: Verify package.json
        run: |
          echo "Verifying package.json..."
          node -e "
            const pkg = require('./package.json');
            console.log('Package name:', pkg.name);
            console.log('Package version:', pkg.version);
            console.log('Package files:', pkg.files);
            if (!pkg.name || !pkg.version) {
              console.error('?Error: package.json is missing name or version');
              process.exit(1);
            }
          "
      
      - name: Publish to npm with provenance
        run: |
          echo "Publishing to npm with provenance..."
          echo "Package: tree-processor"
          echo "Version: ${{ steps.version.outputs.version }}"
          npm publish --provenance --access public
          echo "?Successfully published to npm!"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      
      - name: Verify publication
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "Verifying publication..."
          sleep 5
          if npm view tree-processor@$VERSION version > /dev/null 2>&1; then
            echo "?Successfully verified: tree-processor@$VERSION is now on npm"
            npm view tree-processor@$VERSION
          else
            echo "‚ö†Ô∏è Warning: Could not verify publication immediately. Please check npm manually."
          fi